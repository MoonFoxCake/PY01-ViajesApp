name: Coverage Testing, Build And Publish Image to Docker

on:
  push:
    branches: [ "main" ]

jobs:
    cov_and_publish:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v2
              with:
                python-version: '3.12'

            - name: Setup Compose
              run: docker compose up -d --build

            - name: Run tests
              run: |
                docker exec -t py01-viajesapp-webapp-1 /bin/bash -c "poetry run coverage run -m pytest tests/testdb.py && poetry run coverage xml"
